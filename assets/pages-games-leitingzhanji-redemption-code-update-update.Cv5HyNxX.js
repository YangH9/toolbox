import{_ as e,U as a,K as l,r as t,c as s,a as i,g as o,h as d,w as c,u as r,F as n,H as u,ak as _,J as m,s as f,i as p,C as v,b as y,D as x,o as g,a7 as b,e as h,B as w,t as k,f as T,n as $,q as C,I as j,ac as N,v as V}from"./index-DSrgu0-F.js";import{_ as S}from"./uni-popup.c8OeExLO.js";import{a as J,c as O}from"./config.Dny4K3GL.js";const M=e({__name:"update",setup(e){var M;uni.$sharePageTitle=`编辑兑换码-${J}`;const K=l("dayjs");let U={};const D=null==(M=a)?void 0:M().enableDebug,Y=[Array.from({length:3},((e,a)=>({label:K().year()+a-1+"年",value:K().year()+a-1}))),Array.from({length:12},((e,a)=>({label:`${a+1}月`,value:a+1}))),Array.from({length:31},((e,a)=>({label:`${a+1}日`,value:a+1})))],A=t([0,0,0]),P=t({updateTime:"",rewardKeyMap:[],data:[]}),q=t(),I=t({index:0,code:"",reward:["","","","","",""],invalidityTime:"",desc:"",isNew:!1});u({title:"加载中"}),_({url:`https://runjs.work/transformer/project?id=${O}`,sslVerify:!1,success:e=>{var a,l;const t=null==(l=null==(a=e.data.data)?void 0:a.js)?void 0:l.source;if(U=e.data.data,t){const e=JSON.parse(t.replace(/\n/g," ").replace(/&quot;/g,'"')),{updateTime:a,rewardKeyMap:l,data:s}=e;P.value.updateTime=a,P.value.rewardKeyMap=l,P.value.data=s.reverse()}else f({title:"资源加载异常",icon:"none"})},fail:()=>{f({title:"资源加载失败",icon:"error"})},complete:()=>{m()}});const B=()=>{P.value.data.unshift({code:"",reward:["","","","","",""],invalidityTime:"",desc:"",isNew:!0})},E=()=>{V({title:"提示",content:"确定删除吗？",success:e=>{e.confirm&&(P.value.data.splice(I.value.index,1),q.value.close())}})},F=()=>{const e=K();A.value=[1,e.month(),e.date()-1]},H=e=>{const{value:a}=e.detail,l=K(Y.map(((e,l)=>e[a[l]].value)).join("/"));P.value.updateTime=l.format("YYYY/MM/DD")},W=e=>{const{index:a}=e.currentTarget.dataset,l=JSON.parse(JSON.stringify(P.value.data[a]));I.value={index:a,...l},q.value.open()},z=(e,a)=>{void 0===a?I.value[e]="":I.value[e][a]=""},G=()=>{q.value.close()},L=()=>{const{index:e,...a}=I.value;a.code?(P.value.data[e]=JSON.parse(JSON.stringify(a)),q.value.close()):f({title:"请输入兑换码",icon:"none"})},Q=()=>{u({title:"保存中……"});const{updateTime:e,data:a}=JSON.parse(JSON.stringify(P.value)),l=U.js.source.replace(/"updateTime": "[0-9/]{10}"/,`"updateTime": "${e}"`).replace(/"data": \[[\s\S.]*  \]/,`"data": [${a.reverse().map((e=>`\n    { "code": "${e.code}", "reward": [${e.reward.map((e=>`"${e||""}"`)).join(", ")}]${e.invalidityTime?`, "invalidityTime": "${e.invalidityTime}"`:""}${e.desc?`, "desc": "${e.desc}"`:""}${e.isNew?', "isNew": true':""} }`)).join(",")}\n  ]`);U.js.source=l,_({url:"https://runjs.work/transformer/store?isTemp=0",sslVerify:!1,data:{data:U},header:{cookie:uni.$runjsCookie},method:"POST",success:e=>{0===e.data.code?f({title:"保存成功"}):f({title:`保存失败-${e.data.message}`,icon:"none"})},fail:()=>{f({title:"保存失败，网络异常",icon:"error"})},complete:()=>{m()}})};return(e,a)=>{const l=y("my-page-header"),t=p,u=w,_=b,m=y("my-bottom-safety-space"),f=C,V=j,J=N,O=v(x("uni-popup"),S);return g(),s(n,null,[i(l),i(t,{class:"pt_4"},{default:c((()=>[i(_,{class:"cursor_default",mode:"multiSelector","range-key":"label",value:A.value,range:Y,onClick:F,onChange:H},{default:c((()=>[i(t,{class:"mx_4 mb_4 shadow radius bg-color"},{default:c((()=>[i(t,{class:"d_flex px_4 items_center"},{default:c((()=>[i(t,{class:"font_bold grow"},{default:c((()=>[h("时间")])),_:1}),P.value.updateTime?(g(),o(t,{key:0},{default:c((()=>[i(u,{class:"text-info text_base"},{default:c((()=>[h(k(P.value.updateTime),1)])),_:1})])),_:1})):d("",!0),i(t,{class:"my-icon-chevron-right text_xxl"})])),_:1})])),_:1})])),_:1},8,["value"]),i(t,{class:"mx_4 mb_4 shadow radius bg-color"},{default:c((()=>[(g(!0),s(n,null,T(P.value.data,((e,a)=>(g(),o(t,{key:a,class:$(["d_flex items_center text_base px_4 p_relative",0===a?"radius_t border_b":a===P.value.data.length?"radius_b":"border_b"]),"hover-class":"bg-hover","data-index":a,onClick:W},{default:c((()=>[i(t,{class:"py_4"},{default:c((()=>[h(k(e.code),1),i(t,{class:"text-info text_xs"},{default:c((()=>[h(k(e.desc),1)])),_:2},1024)])),_:2},1024),i(t,{class:"grow"}),i(t,{class:"text-info text_right"},{default:c((()=>[h(k(e.reward.map(((e,a)=>((e,a)=>a?`${a}${P.value.rewardKeyMap[e]||""}`:"")(a,e))).filter((e=>e)).join("，"))+" ",1),e.invalidityTime?(g(),o(t,{key:0,class:"text-info text_xs"},{default:c((()=>[h("失效时间："+k(e.invalidityTime),1)])),_:2},1024)):d("",!0)])),_:2},1024),e.invalidityTime&&r(K)(`${e.invalidityTime} 23:59:59`)<r(K)()?(g(),o(t,{key:0,class:"yang-badge ribbon info"},{default:c((()=>[i(t,{class:"content basic"},{default:c((()=>[h("已失效")])),_:1})])),_:1})):d("",!0),"永久"===e.invalidityTime?(g(),o(t,{key:1,class:"yang-badge ribbon"},{default:c((()=>[i(t,{class:"content basic"},{default:c((()=>[h("永久")])),_:1})])),_:1})):d("",!0),e.isNew?(g(),o(t,{key:2,class:"yang-badge ribbon"},{default:c((()=>[i(t,{class:"content basic"},{default:c((()=>[h("NEW")])),_:1})])),_:1})):d("",!0),i(t,{class:"my-icon-chevron-right text_xxl"})])),_:2},1032,["class","data-index"])))),128))])),_:1})])),_:1}),r(D)?(g(),o(t,{key:0,class:"save yang-fab yang-button primary circle",onClick:Q},{default:c((()=>[i(t,{class:"my-icon-save text_xxl"})])),_:1})):d("",!0),i(t,{class:"plus yang-fab yang-button primary circle",onClick:B},{default:c((()=>[i(t,{class:"my-icon-plus text_xxl"})])),_:1}),i(m,{version:""}),i(O,{ref_key:"editPopup",ref:q,type:"bottom","safe-area":!1},{default:c((()=>[i(t,{class:"bg-color radius_t"},{default:c((()=>[i(t,{class:"d_flex px_4 py_3 items_center"},{default:c((()=>[i(t,{class:"font_bold"},{default:c((()=>[h("编辑兑换码")])),_:1}),i(t,{class:"grow"}),i(f,{class:"yang-button danger outline extra-small my-icon-delete","hover-class":"hover",onClick:E})])),_:1}),i(t,{class:"d_flex px_4 py_2 items_center border_t"},{default:c((()=>[i(t,{class:"title"},{default:c((()=>[h("兑换码")])),_:1}),i(V,{modelValue:I.value.code,"onUpdate:modelValue":a[0]||(a[0]=e=>I.value.code=e),class:"grow text_right",placeholder:"请输入兑换码"},null,8,["modelValue"]),i(t,{class:"my-icon-close-circle text-info ml_2",onClick:a[1]||(a[1]=e=>z("code"))})])),_:1}),(g(!0),s(n,null,T(P.value.rewardKeyMap,((e,a)=>(g(),o(t,{key:a,class:"d_flex px_4 py_2 items_center border_t"},{default:c((()=>[i(t,{class:"title"},{default:c((()=>[h(k(e),1)])),_:2},1024),i(V,{modelValue:I.value.reward[a],"onUpdate:modelValue":e=>I.value.reward[a]=e,class:"grow text_right",placeholder:`请输入${e}`},null,8,["modelValue","onUpdate:modelValue","placeholder"]),i(t,{class:"my-icon-close-circle text-info ml_2",onClick:e=>z("reward",a)},null,8,["onClick"])])),_:2},1024)))),128)),i(t,{class:"d_flex px_4 py_2 items_center border_t"},{default:c((()=>[i(t,{class:"title"},{default:c((()=>[h("是否新增")])),_:1}),i(t,{class:"grow"}),i(J,{checked:I.value.isNew,onChange:a[2]||(a[2]=e=>I.value.isNew=e.detail.value)},null,8,["checked"])])),_:1}),i(t,{class:"d_flex px_4 py_2 items_center border_t"},{default:c((()=>[i(t,{class:"title"},{default:c((()=>[h("失效时间")])),_:1}),i(V,{modelValue:I.value.invalidityTime,"onUpdate:modelValue":a[3]||(a[3]=e=>I.value.invalidityTime=e),class:"grow text_right",placeholder:"请输入失效时间"},null,8,["modelValue"]),i(t,{class:"my-icon-close-circle text-info ml_2",onClick:a[4]||(a[4]=e=>z("invalidityTime"))})])),_:1}),i(t,{class:"d_flex px_4 py_2 items_center border_t"},{default:c((()=>[i(t,{class:"title"},{default:c((()=>[h("备注")])),_:1}),i(V,{modelValue:I.value.desc,"onUpdate:modelValue":a[5]||(a[5]=e=>I.value.desc=e),class:"grow text_right",placeholder:"请输入备注"},null,8,["modelValue"]),i(t,{class:"my-icon-close-circle text-info ml_2",onClick:a[6]||(a[6]=e=>z("desc"))})])),_:1}),i(t,{class:"d_flex px_4 py_3 items_center border_t"},{default:c((()=>[i(f,{class:"yang-button outline block","hover-class":"hover",onClick:G},{default:c((()=>[h("取消")])),_:1}),i(f,{class:"yang-button primary block","hover-class":"hover",onClick:L},{default:c((()=>[h("保存")])),_:1})])),_:1}),i(t,{class:"h_safe"})])),_:1})])),_:1},512)],64)}}},[["__scopeId","data-v-2f13de5c"]]);export{M as default};
